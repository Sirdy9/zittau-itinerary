<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Mapa itineráře Zittau a okolí</title>
    <!-- Ensure proper scaling on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Include Leaflet CSS -->
  <!-- Include Leaflet CSS without SRI attributes (avoids integrity mismatch issues) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />

    <!-- Modern font for a fresher look -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- PWA manifest and icons -->
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <meta name="theme-color" content="#377eb8" />
    <!-- Allow the app to run full‑screen when added to the Home Screen on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- Set the status bar appearance to translucent so the app content extends behind it -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    /* Set the map height to fill the viewport */
    #map {
      height: 600px;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      /* Use a modern sans-serif font for a cleaner aesthetic */
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      /* Respect iOS safe area insets so content does not collide with notches or rounded corners */
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
    }
    h1 {
      font-size: 1.5em;
      margin: 1em;
      text-align: center;
    }
    .leaflet-popup-content {
      font-size: 0.9em;
    }

    /* Responsive adjustments for small screens */
    @media (max-width: 600px) {
      #daySelector,
      #controls {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #daySelector select,
      #controls select,
      #controls button,
      #searchInput {
        width: 90%;
        margin-bottom: 8px;
      }
      #map {
        /* Leave room for controls on small devices */
        height: calc(100vh - 240px);
      }
    }

    /* Modern card styling for the control panels */
    #daySelector, #controls {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 10px 16px;
      margin: 0 1em 1em 1em;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }
    .dark-theme #daySelector, .dark-theme #controls {
      background: rgba(40, 40, 40, 0.95);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    /* Dark theme styling for the entire page */
    .dark-theme {
      background-color: #121212;
      color: #f5f5f5;
    }
    .dark-theme select,
    .dark-theme button,
    .dark-theme input {
      background-color: #2a2a2a;
      color: #f5f5f5;
      border-color: #555;
    }
    .dark-theme #map {
      /* invert map colors for better dark readability */
      filter: invert(90%) hue-rotate(180deg);
    }
    /* Reduce motion when battery saver is on */
    .reduce-motion * {
      transition: none !important;
      animation: none !important;
    }

    /* Larger tap targets for mobile users */
    button {
      padding: 8px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      background-color: #377eb8;
      color: #ffffff;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #2c6ca7;
    }
    .dark-theme button {
      background-color: #4f81c7;
      color: #f5f5f5;
    }

    /* Offline/online indicator styling */
    #offlineIndicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 999;
      text-align: center;
      padding: 4px;
      font-size: 12px;
      color: #ffffff;
    }
    .online {
      background-color: #4caf50;
    }
    .offline {
      background-color: #f44336;
    }

    /* Add‑to‑Home‑Screen banner styling */
    #installBanner {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: #fff7e6;
      border: 1px solid #ffa500;
      border-radius: 4px;
      padding: 12px;
      z-index: 1000;
      display: none;
      font-size: 14px;
    }
    #installBanner button {
      margin-left: 12px;
      padding: 4px 8px;
      font-size: 14px;
    }

    /* Info button and modal styling */
    #infoBtn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      background-color: #377eb8;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #infoModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 16px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      z-index: 2000;
      display: none;
      color: #000000;
    }
    .dark-theme #infoModal {
      background: #2a2a2a;
      border-color: #444;
      color: #f5f5f5;
    }
    #infoModal button {
      margin-top: 12px;
    }

    /* Chat widget styles */
    #chatToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 8px 12px;
      background-color: #377eb8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #chatBox {
      position: fixed;
      bottom: 60px;
      right: 20px;
      width: 300px;
      max-height: 400px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    /* Chat improvements */
    #chatBox {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    #chatMessages {
      padding: 12px;
      font-size: 14px;
    }
    #chatInputWrapper {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #chatInputWrapper input {
      flex: 1;
      border: none;
      padding: 8px;
      font-size: 14px;
    }
    #chatInputWrapper button {
      border: none;
      padding: 8px 12px;
      background-color: #377eb8;
      color: white;
      cursor: pointer;
    }
    #chatInputWrapper button:hover {
      background-color: #2c6ca7;
    }
    #chatMessages {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
      font-size: 14px;
    }
    #chatInputWrapper {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #chatInputWrapper input {
      flex: 1;
      border: none;
      padding: 6px;
      font-size: 14px;
    }
    #chatInputWrapper button {
      border: none;
      padding: 6px 10px;
      background-color: #377eb8;
      color: white;
      cursor: pointer;
    }
    /* Dark theme adjustments for chat */
    .dark-theme #chatBox {
      background: #2a2a2a;
      border-color: #444;
      color: #f5f5f5;
    }
    .dark-theme #chatInputWrapper {
      border-color: #444;
    }
    .dark-theme #chatInputWrapper input {
      background: #1f1f1f;
      color: #f5f5f5;
    }
    .dark-theme #chatInputWrapper button {
      background: #555;
      color: #f5f5f5;
    }

    /* QR code container styles */
    #qrContainer {
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      z-index: 1000;
      display: none;
      text-align: center;
    }
    .dark-theme #qrContainer {
      background: #2a2a2a;
      border-color: #444;
      color: #f5f5f5;
    }
  </style>
</head>
<body>
  <h1>Interaktivní mapa psího itineráře – Zittau a okolí</h1>
  <!-- Online/offline status indicator -->
  <div id="offlineIndicator" class="online">Online</div>
  <!-- Day selector UI -->
  <div id="daySelector" style="text-align:center; margin-bottom:10px;">
    <label for="daySelect">Vyber den: </label>
    <select id="daySelect" style="padding:4px;">
      <option value="all">Všechny dny</option>
      <option value="Středa">Středa</option>
      <option value="Čtvrtek">Čtvrtek</option>
      <option value="Pátek">Pátek</option>
      <option value="Sobota">Sobota</option>
      <option value="Neděle">Neděle</option>
      <option value="Pondělí">Pondělí</option>
    </select>
  </div>
  <!-- Additional controls: share link and theme toggle -->
  <div id="controls" style="text-align:center; margin-bottom:10px;">
    <!-- Skrytý tlačítko pro sdílení odkazu (už není součástí zjednodušené verze) -->
    <button id="shareBtn" style="display:none; padding:4px 8px; margin-right:8px;">Vygenerovat odkaz</button>
    <label for="themeSelect">Téma mapy: </label>
    <select id="themeSelect" style="padding:4px;">
      <option value="day">Denní</option>
      <option value="night">Noční</option>
    </select>

    <!-- Skrytý geolokační tlačítko (není potřeba) -->
    <button id="locateBtn" style="display:none; padding:4px 8px; margin-left:8px;">Zobrazit moji polohu</button>

    <!-- Offline mode toggle.  When enabled, the service worker will serve map tiles from cache only. -->
    <label style="margin-left:12px;">
      <input type="checkbox" id="offlineToggle" /> Offline mód
    </label>

    <!-- Skrytý vyhledávací vstup (zjednodušená verze nepotřebuje vyhledávání) -->
    <input id="searchInput" list="searchList" placeholder="Vyhledat místo…" style="display:none; padding:4px 8px; margin-left:12px;" />
    <datalist id="searchList" style="display:none;"></datalist>

    <!-- Additional controls: QR code, admin mode and tracking are skryté ve zjednodušené verzi -->
    <button id="qrBtn" style="display:none; padding:4px 8px; margin-left:8px;">QR kód</button>
    <button id="adminToggle" style="display:none; padding:4px 8px; margin-left:8px;">Admin: OFF</button>
    <label style="display:none; margin-left:12px;">
      <input type="checkbox" id="trackingToggle" /> Sledovat pohyb
    </label>
  </div>
  <div id="map"></div>

  <!-- Floating interactive elements: chat and QR code are hidden in the optimized version -->
  <button id="chatToggle" style="display:none;">💬</button>
  <div id="chatBox" style="display:none;">
    <div id="chatMessages"></div>
    <div id="chatInputWrapper">
      <input type="text" id="chatInput" placeholder="Zeptejte se..." />
      <button id="chatSend">Poslat</button>
    </div>
  </div>
  <div id="qrContainer" style="display:none;">
    <div id="qrcode"></div>
    <button id="qrClose" style="margin-top:8px;">Zavřít</button>
    <!-- Link to open the generated itinerary in Safari (iOS) -->
    <a id="openSafariLink" href="#" style="display:none; margin-top:8px;" target="_blank">Otevřít v Safari</a>
  </div>

  <!-- Add‑to‑Home‑Screen prompt for iOS users -->
  <div id="installBanner">
    <span>Přidej na plochu: klikni na tlačítko sdílení → Přidat na plochu</span>
    <button id="installClose" aria-label="Zavřít banner">×</button>
  </div>

  <!-- Info button and modal for version info and log export -->
  <button id="infoBtn" aria-label="Zobrazit informace">ℹ️</button>
  <div id="infoModal">
    <h2>Informace o itineráři</h2>
    <p><strong>Verze itineráře:</strong> <span id="itineraryVersion"></span></p>
    <p><strong>Naposledy uloženo:</strong> <span id="lastSaved"></span></p>
    <p><strong>Log chyb:</strong></p>
    <pre id="errorLog" style="white-space: pre-wrap; word-break: break-word; max-height:200px; overflow-y:auto;"></pre>
    <!-- Added screenshot section to provide guidance for Firebase setup -->
    <h3>Snímek obrazovky</h3>
    <p>Ukázka nastavení webové aplikace s Firebase SDK:</p>
    <img src="091e1c8f-1995-418e-8bdb-f31e916fc16f.png" alt="Ukázka nastavení Firebase" style="max-width:100%; height:auto; border-radius:8px; margin-bottom:8px;">

    <!-- Export/import backup functions for offline usage (optional) -->
    <div id="exportImport" style="margin-top:12px;">
      <button onclick="exportState()" style="padding:4px 8px; margin-right:8px;">Exportovat stav</button>
      <input type="file" onchange="importState(this.files[0])" />
    </div>
    <button id="exportLog">Exportovat log</button>
    <button id="infoClose">Zavřít</button>
  </div>
  <!-- Include Leaflet JS -->
  <!-- Include Leaflet JS without SRI attributes -->
  <script
    src="https://unpkg.com/leaflet/dist/leaflet.js"
  ></script>

  <!-- QRCode library removed in optimized version -->
  <!-- LZ‑String library for compressing/decompressing shared data -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

  <script>
    // Initialize the map centered on Zittau
    var map = L.map('map').setView([50.89, 14.8], 11);
    // Define base layers for day and night themes.  The day layer uses the
    // standard OpenStreetMap tiles and the night layer uses Carto's dark tiles.
    var dayLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap přispěvatelé'
    });
    var nightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap přispěvatelé, © Carto'
    });
    // Keep track of the currently displayed base layer; default to day
    var currentBase = dayLayer;
    currentBase.addTo(map);

    // --------------------------------------------------------------
    // Adaptive tile loading based on network connection
    //
    // Some mobile networks (e.g. 3G, 2G) have limited bandwidth. To improve
    // performance and reduce data usage on slower connections, detect the
    // effective connection type via the Network Information API and switch to
    // a simplified base layer with fewer details and a slightly lower zoom
    // level. On fast connections (4g/5g), keep the original map tiles.
    if (navigator.connection && navigator.connection.effectiveType) {
      var connType = navigator.connection.effectiveType;
      // Accept both string and potential object values. Some browsers return
      // values like '4g', '3g', '2g', 'slow-2g', etc.
      if (typeof connType === 'string' && connType !== '4g' && connType !== '5g') {
        try {
          // Remove the current base layer and load a lower‑detail layer to reduce
          // data usage. Carto's light_nolabels tiles have fewer labels and
          // therefore require fewer bytes.  Use the same attribution as other
          // Carto layers.
          if (map.hasLayer(currentBase)) {
            map.removeLayer(currentBase);
          }
          currentBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap přispěvatelé, © Carto'
          });
          currentBase.addTo(map);
          // Optionally zoom out one level to fetch fewer tiles. Only zoom out
          // if the current zoom is above a reasonable minimum (e.g., 8).
          var currentZoom = map.getZoom();
          if (currentZoom > 8) {
            map.setZoom(currentZoom - 1);
          }
        } catch (e) {
          console.warn('Adaptive tile loading failed:', e);
        }
      }
    }

    /*
     * Data for itinerary locations.  Each entry contains:
     *  - id: unique identifier used for storing uploaded files
     *  - day: the Czech day label (Středa, Čtvrtek, Pátek, Sobota, Neděle, Pondělí)
     *  - name: name of the location
     *  - coords: [lat, lon]
     *  - details: HTML description of the activities (without day title)
     *  Coordinates have been checked against authoritative sources: e.g., Zittau–Oybin/Jonsdorf railway coordinates 50.890551°N 14.791767°E【518770110847494†L147-L164】.
     */
    var locations = [
      {
        id: 'streda-centre',
        day: 'Středa',
        name: 'Pop‑Art Viertel &amp; Zittau centrum',
        coords: [50.89611, 14.80722],
        details: 'Aktivity: street art v Pop‑Art Viertel, procházka historickým centrem, kostely (zvenku) a Mandava.<br><b>Pes vítán:</b> vstup se psem povolen na vodítku.<br><b>Gästekarte:</b> MHD zdarma.'
      },
      {
        id: 'ctvrtek-vlak',
        day: 'Čtvrtek',
        name: 'Zittauer Schmalspurbahn',
        coords: [50.890551, 14.791767], // zastávka Zittau Vorstadt per Wikipedia【518770110847494†L147-L164】
        details: 'Aktivity: jízda historickou úzkokolejkou do hor.<br><b>Pes vítán:</b> pes může jet na vodítku (náhubek doporučen).<br><b>Gästekarte:</b> kryje jízdenku, doplatíš 10 € za historickou trať.'
      },
      {
        id: 'ctvrtek-oybin',
        day: 'Čtvrtek',
        name: 'Hrad a klášter Oybin',
        coords: [50.842912, 14.740906],
        details: 'Aktivity: prohlídka ruin vytesaných do skály.<br><b>Pes vítán:</b> psi vítáni.<br><b>Gästekarte:</b> pokryto v ceně jízdenky s příplatkem.'
      },
      {
        id: 'ctvrtek-topfer',
        day: 'Čtvrtek',
        name: 'Töpferberg (Töpfer)',
        coords: [50.84833, 14.76222],
        details: 'Aktivity: výšlap k skalním útvarům “želva” a “papoušek”.<br><b>Pes vítán:</b> terén vhodný pro psy na vodítku.'
      },
      {
        id: 'patek-nonnenfelsen',
        day: 'Pátek',
        name: 'Nonnenfelsen',
        coords: [50.85049, 14.68395],
        details: 'Aktivity: dramatické skalní věže, průchody a vyhlídky.<br><b>Pes vítán:</b> vhodné pro psy na vodítku.'
      },
      {
        id: 'patek-jonsdorf',
        day: 'Pátek',
        name: 'Jonsdorf (Felsenstadt)',
        coords: [50.85751, 14.70922],
        details: 'Aktivity: procházka po skalním městě a relax v Gebirgsbad Jonsdorf.<br><b>Pes vítán:</b> psi mohou zůstat na louce u koupaliště.<br><b>Gästekarte:</b> doprava zdarma do Jonsdorfu.'
      },
      {
        id: 'sobota-breiteberg',
        day: 'Sobota',
        name: 'Breiteberg',
        coords: [50.89194, 14.70444],
        details: 'Aktivity: výšlap s rozhlednou a výhledy na tři státy.<br><b>Pes vítán:</b> lesní cesta přívětivá pro psy.<br><b>Gästekarte:</b> možnost využít dopravu zdarma.'
      },
      {
        id: 'sobota-jezero',
        day: 'Sobota',
        name: 'Olbersdorfer See',
        coords: [50.89268, 14.776847],
        details: 'Aktivity: pláž, koupání v jezeře s psí zónou a piknik.<br><b>Pes vítán:</b> psi mohou do vody.<br><b>Gästekarte:</b> doprava zdarma do Olbersdorfu.'
      },
      {
        id: 'nedele-troji',
        day: 'Neděle',
        name: 'Dreiländereck (Trojmezí)',
        coords: [50.87028, 14.82278],
        details: 'Aktivity: stát současně v Německu, Polsku a Česku; ideální na fotky.<br><b>Pes vítán:</b> přístup pěšky nebo autobusem.<br><b>Gästekarte:</b> autobus zdarma.'
      },
      {
        id: 'nedele-tierpark',
        day: 'Neděle',
        name: 'Tierpark Zittau',
        coords: [50.901463, 14.83246],
        details: 'Aktivity: menší zoologická zahrada s cca 70 druhy.<br><b>Pes vítán:</b> psi vítáni na vodítku.<br><b>Gästekarte:</b> sleva na vstup.'
      },
      {
        id: 'pondeli-waltersdorf',
        day: 'Pondělí',
        name: 'Waltersdorf',
        coords: [50.8667, 14.65],
        details: 'Aktivity: krátký výlet do Waltersdorfu za roubenými domy; procházka podél Mandavy nebo přes Triebeltal.<br><b>Pes vítán:</b> pohodový den na závěr.'
      }
    ];

    // On load, override default locations with any custom data saved by the admin in localStorage
    (function() {
      try {
        var savedCustom = localStorage.getItem('custom-locations');
        if (savedCustom) {
          var arr = JSON.parse(savedCustom);
          if (Array.isArray(arr)) {
            locations = arr;
          }
        }
      } catch (e) {
        console.warn('Nelze načíst uložená místa:', e);
      }
    })();

    // -----------------------------------------------------------------------
    // Real‑time synchronizace napříč okny/panely
    //
    // Pomocí BroadcastChannel přenášíme seznam míst mezi všemi otevřenými
    // instancemi aplikace. Každá karta získá jedinečné ID a při uložení
    // seznamu lokalit se odešle zpráva s novými daty. Při příjmu zprávy z
    // jiné karty se seznam uloží do localStorage a stránka se obnoví,
    // aby se načetly aktuální body.  Tím je zajištěno synchronní sdílení
    // itineráře v reálném čase.
    var tabId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    var bc = new BroadcastChannel('itinerary-sync');
    bc.onmessage = function(ev) {
      try {
        var msg = ev.data;
        // ignoruj zprávy poslané z aktuální karty
        if (msg && msg.sender && msg.sender === tabId) return;
        if (msg && msg.data && Array.isArray(msg.data)) {
          // ulož přijatá data a reloaduj, aby se aktualizovalo zobrazení
          localStorage.setItem('custom-locations', JSON.stringify(msg.data));
          location.reload();
        }
      } catch (e) {
        console.warn('Chyba při zpracování synchronizované zprávy:', e);
      }
    };
    function broadcastLocations() {
      try {
        bc.postMessage({ sender: tabId, data: locations });
      } catch (e) {
        console.warn('Nelze odeslat synchronizační zprávu:', e);
      }
    }

    // Colour palette for each day of the itinerary
    var dayColors = {
      'Středa': '#e41a1c',
      'Čtvrtek': '#377eb8',
      'Pátek': '#4daf4a',
      'Sobota': '#984ea3',
      'Neděle': '#ff7f00',
      'Pondělí': '#f0c400'
    };

    // Object to collect routes for each day
    var dayRoutes = {};

    // Initialize dayRoutes arrays
    Object.keys(dayColors).forEach(function(d) { dayRoutes[d] = []; });

    // Starting point for each day: FeWo Art Deco (Weinauallee 20, Zittau)
    // Coordinates taken from the object location on Wikimedia Commons (50°53′54.9″N, 14°49′24.47″E)【297725515072598†L154-L159】
    var feWoCoords = [50.898583, 14.823447];

    // Objects to store markers and polylines per day
    var dayMarkers = {};
    var dayPolylines = {};
    Object.keys(dayColors).forEach(function(d) { dayMarkers[d] = []; dayPolylines[d] = null; });

    // Object to store fetched road routes per day; these polylines will be drawn on selection
    var routeLines = {};

    /**
     * Helper to create a circle marker with a custom colour.  We use circle
     * markers instead of default pins to distinguish days via colour.
     */
    function createDayMarker(latlng, color) {
      return L.circleMarker(latlng, {
        radius: 8,
        color: color,
        fillColor: color,
        fillOpacity: 0.85
      });
    }

    // Add each marker to the map with tooltip, popup and file upload
    locations.forEach(function(loc, index) {
      // Append coordinates to routes per day
      dayRoutes[loc.day].push(loc.coords);
      // Create coloured circle marker
      var marker = createDayMarker(loc.coords, dayColors[loc.day]);
      marker.addTo(map);
      marker.bindTooltip(loc.name);
      // Build dynamic popup content including file uploader and list
      var popupId = 'popup-' + index;
      var inputId = 'file-input-' + index;
      var listId = 'file-list-' + index;
      var popupContent = '<b>' + loc.day + ' – ' + loc.name + '</b><br>' + loc.details +
        '<hr style="margin:4px 0;">' +
        '<label>📎 Nahraj soubor (např. jízdenku): <input type="file" id="' + inputId + '"></label>' +
        '<div id="' + listId + '" style="margin-top:4px;"></div>';
      marker.bindPopup(popupContent);
      // When popup opens, hook up the file input event and restore stored files
      marker.on('popupopen', function() {
        var fileInput = document.getElementById(inputId);
        var fileListDiv = document.getElementById(listId);
        // Helper to render file list
        function renderFileList(files) {
          fileListDiv.innerHTML = '';
          if (!files || files.length === 0) return;
          files.forEach(function(file, idx) {
            var link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            link.textContent = '🗎 ' + file.name;
            link.style.display = 'block';
            fileListDiv.appendChild(link);
          });
        }
        // Load stored files from localStorage
        var stored = localStorage.getItem('files-' + loc.id);
        var storedFiles = stored ? JSON.parse(stored) : [];
        renderFileList(storedFiles);
        // Attach change listener once
        if (fileInput && !fileInput._listenerAdded) {
          fileInput.addEventListener('change', function(ev) {
            var selected = ev.target.files;
            if (!selected || selected.length === 0) return;
            var file = selected[0];
            // Compress image files before saving to reduce payload size
            if (/^image\//.test(file.type)) {
              compressImage(file, 1024, function(dataUrl) {
                storedFiles.push({ name: file.name, data: dataUrl });
                try {
                  localStorage.setItem('files-' + loc.id, JSON.stringify(storedFiles));
                } catch (e) {}
                renderFileList(storedFiles);
              });
            } else {
              var reader = new FileReader();
              reader.onload = function(e) {
                storedFiles.push({ name: file.name, data: e.target.result });
                try {
                  localStorage.setItem('files-' + loc.id, JSON.stringify(storedFiles));
                } catch (e) {}
                renderFileList(storedFiles);
              };
              reader.readAsDataURL(file);
            }
          });
          fileInput._listenerAdded = true;
        }
      });
      // Record marker by day for later visibility toggling
      dayMarkers[loc.day].push(marker);
    });

    // Build straight-line polylines for each day but do not add them to map yet
    Object.keys(dayRoutes).forEach(function(day) {
      var coords = dayRoutes[day];
      if (coords.length > 0) {
        // Prepend the start point FeWo for each day
        var fullCoords = [feWoCoords].concat(coords);
        // Create a dashed polyline; do not add to map
        var polyline = L.polyline(fullCoords, {
          color: dayColors[day],
          weight: 3,
          opacity: 0.6,
          dashArray: '5,5'
        });
        dayPolylines[day] = polyline;
      }
    });

    /**
     * Update marker and route visibility based on selected day.
     * When a specific day is selected, only markers and route for that day are shown.
     * For "all" selection, everything is displayed.
     */
    function updateVisibility(selectedDay) {
      // First hide all markers and polylines and route lines
      Object.keys(dayMarkers).forEach(function(day) {
        dayMarkers[day].forEach(function(m) {
          if (map.hasLayer(m)) map.removeLayer(m);
        });
        // remove fetched route line if exists
        if (routeLines[day] && map.hasLayer(routeLines[day])) {
          map.removeLayer(routeLines[day]);
        }
        // remove fallback polyline
        var poly = dayPolylines[day];
        if (poly && map.hasLayer(poly)) {
          map.removeLayer(poly);
        }
      });
      if (selectedDay === 'all') {
        // Show all markers and fallback polylines
        Object.keys(dayMarkers).forEach(function(day) {
          dayMarkers[day].forEach(function(m) {
            m.addTo(map);
          });
          var poly = dayPolylines[day];
          if (poly) poly.addTo(map);
        });
      } else {
        // Show only markers for selected day
        dayMarkers[selectedDay].forEach(function(m) {
          m.addTo(map);
        });
        // Fetch real route for selected day; fallback to dashed polyline if fetch fails
        fetchRouteForDay(selectedDay);
      }
    }

    // Attach change listener to the day selector dropdown
    var daySelectElement = document.getElementById('daySelect');
    daySelectElement.addEventListener('change', function() {
      var chosen = this.value;
      updateVisibility(chosen);
    });
    // Initial visibility: show all
    updateVisibility('all');

    // Attach event listeners for share button and theme selector
    var shareButton = document.getElementById('shareBtn');
    var themeSelectElement = document.getElementById('themeSelect');
    if (shareButton) {
      // When the user clicks the share button, attempt to use the native Web Share API
      // if available; otherwise fall back to a prompt with the generated URL.
      shareButton.addEventListener('click', function() {
        shareItinerary();
      });
    }
    if (themeSelectElement) {
      themeSelectElement.addEventListener('change', function() {
        var theme = this.value;
        // Swap base layers based on theme selection
        if (theme === 'night') {
          if (map.hasLayer(currentBase)) {
            map.removeLayer(currentBase);
          }
          currentBase = nightLayer;
          currentBase.addTo(map);
        } else {
          if (map.hasLayer(currentBase)) {
            map.removeLayer(currentBase);
          }
          currentBase = dayLayer;
          currentBase.addTo(map);
        }
      });
    }

    // If the URL contains shared data (encoded after #data=), restore it to localStorage.
    (function() {
      var hash = window.location.hash;
      // Data is encoded via LZ‑String (compressToEncodedURIComponent) to ensure compact payloads.
      if (hash && hash.startsWith('#data=')) {
        try {
          // Extract the compressed payload (without the '#data=' prefix). Do not decodeURIComponent here,
          // because compressToEncodedURIComponent already produces URI‑safe characters.
          var compressed = hash.substring(6);
          // Decompress the string back to JSON. If decompression fails, an exception will be thrown.
          var jsonStr = LZString.decompressFromEncodedURIComponent(compressed);
          if (!jsonStr) throw new Error('Decompression returned null');
          var obj = JSON.parse(jsonStr);
          // Restore each key/value into localStorage. Values are stored as JSON strings.
          Object.keys(obj).forEach(function(key) {
            localStorage.setItem(key, JSON.stringify(obj[key]));
          });
        } catch (err) {
          console.error('Chyba při načítání sdílených dat:', err);
        }
      }
    })();

    /**
     * Vygeneruje sdílecí odkaz na aktuální stav příloh.
     * Pro každý klíč v localStorage začínající na "files-" uloží jejich obsah do objektu,
     * zakóduje ho do base64 a vloží do hash části URL. Zobrazený odkaz lze zkopírovat
     * a poslat přátelům, kteří po otevření stránky obnoví své přílohy.
     */
    function generateShareLink() {
      var shareData = {};
      for (var i = 0; i < localStorage.length; i++) {
        var k = localStorage.key(i);
        if (k && k.indexOf('files-') === 0) {
          try {
            var val = JSON.parse(localStorage.getItem(k));
            shareData[k] = val;
          } catch (e) {
            // skip invalid entries
          }
        }
      }
      var jsonStr = JSON.stringify(shareData);
      // Encode to base64 with unicode support
      var b64 = btoa(unescape(encodeURIComponent(jsonStr)));
      var url = window.location.origin + window.location.pathname + '#data=' + encodeURIComponent(b64);
      // Show a prompt to copy the link.  This UI will appear only when invoked.
      window.prompt('Zkopírujte tento odkaz pro sdílení itineráře s vašimi soubory:', url);
    }

    /**
     * Fetch a driving route for the selected day from the OSRM API.  This uses
     * the public OSRM server at router.project-osrm.org.  If the request
     * succeeds, a polyline following the road network will be drawn.  If it
     * fails (e.g., network issues), the fallback dashed polyline defined
     * earlier will be shown instead.
     * @param {string} day - The day key (e.g., 'Středa', 'Čtvrtek').
     */
    function fetchRouteForDay(day) {
      // Build an array of coordinates starting with FeWo and followed by day's places
      var coords = [feWoCoords].concat(dayRoutes[day]);
      // OSRM expects lon,lat pairs
      var coordStrings = coords.map(function(c) { return c[1] + ',' + c[0]; });
      var url = 'https://router.project-osrm.org/route/v1/driving/' + coordStrings.join(';') + '?overview=full&geometries=geojson';
      fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (!data || !data.routes || data.routes.length === 0) throw new Error('No route');
          var geometry = data.routes[0].geometry.coordinates;
          var lineCoords = geometry.map(function(pt) { return [pt[1], pt[0]]; });
          // Remove existing route line for this day
          if (routeLines[day] && map.hasLayer(routeLines[day])) {
            map.removeLayer(routeLines[day]);
          }
          routeLines[day] = L.polyline(lineCoords, { color: dayColors[day], weight: 4, opacity: 0.9 }).addTo(map);
        })
        .catch(function() {
          // If fetch fails, show fallback dashed polyline
          var poly = dayPolylines[day];
          if (poly && !map.hasLayer(poly)) {
            poly.addTo(map);
          }
        });
    }

    // =======================
    // Additional enhancements
    // =======================

    // Register service worker to enable offline caching of resources and map tiles.
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(function(err) {
        console.error('Registrace service workeru se nezdařila:', err);
      });
    }

    // Geolocation: show the user's current position on the map when requested.
    var locateBtn = document.getElementById('locateBtn');
    if (locateBtn) {
      locateBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
          alert('Geolokace není podporována ve vašem prohlížeči.');
          return;
        }
        navigator.geolocation.getCurrentPosition(function(pos) {
          var lat = pos.coords.latitude;
          var lon = pos.coords.longitude;
          // Remove previous marker/circle if present
          if (window._userMarker) map.removeLayer(window._userMarker);
          if (window._userCircle) map.removeLayer(window._userCircle);
          // Add a marker at the current position using the default Leaflet marker icon
          window._userMarker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png'
            })
          }).addTo(map);
          // Indicate the accuracy with a circle
          window._userCircle = L.circle([lat, lon], {
            radius: pos.coords.accuracy || 0,
            color: '#136aec',
            fillColor: '#136aec',
            fillOpacity: 0.15
          }).addTo(map);
          map.setView([lat, lon], 13);
        }, function(err) {
          alert('Nelze získat polohu: ' + err.message);
        });
      });
    }

    // Offline mode: allow user to force cache-only tile retrieval.
    function updateOfflineMode(enabled) {
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'SET_OFFLINE_MODE', enabled: enabled });
      }
    }
    var offlineToggle = document.getElementById('offlineToggle');
    if (offlineToggle) {
      // Restore preference from localStorage (1 = offline mode on)
      var saved = localStorage.getItem('offline-mode');
      if (saved === '1') {
        offlineToggle.checked = true;
      }
      // Inform service worker after page load to ensure controller is active
      window.addEventListener('load', function() {
        updateOfflineMode(offlineToggle.checked);
      });
      // When user toggles the checkbox, persist preference and notify service worker
      offlineToggle.addEventListener('change', function() {
        var enabled = this.checked;
        localStorage.setItem('offline-mode', enabled ? '1' : '0');
        updateOfflineMode(enabled);
      });
    }

    // AI-like search: implement fuzzy search over itinerary names and descriptions.
    var searchInput = document.getElementById('searchInput');
    var searchList = document.getElementById('searchList');
    if (searchInput && searchList) {
      searchInput.addEventListener('input', function() {
        var q = this.value.trim().toLowerCase();
        searchList.innerHTML = '';
        if (!q) return;
        // Find up to five matches where query is contained in name or details
        var results = locations.filter(function(loc) {
          return loc.name.toLowerCase().includes(q) || loc.details.toLowerCase().includes(q);
        }).slice(0, 5);
        results.forEach(function(loc) {
          var opt = document.createElement('option');
          opt.value = loc.name;
          searchList.appendChild(opt);
        });
      });
      // When the input loses focus or value is set, locate the matching place
      searchInput.addEventListener('change', function() {
        var val = this.value.trim();
        if (!val) return;
        var match = locations.find(function(loc) {
          return loc.name.toLowerCase() === val.toLowerCase();
        });
        if (match) {
          // Update day selector to show the relevant day
          daySelectElement.value = match.day;
          updateVisibility(match.day);
          // Pan to the selected location and open its popup
          map.setView(match.coords, 13);
          var marker = dayMarkers[match.day].find(function(m) {
            var ll = m.getLatLng();
            return ll.lat === match.coords[0] && ll.lng === match.coords[1];
          });
          if (marker) {
            marker.openPopup();
          }
        }
      });
    }

    // =============================
    // Additional features and tools
    // =============================

    /**
     * Build a shareable URL containing the contents of localStorage for files and
     * custom locations. This helper is used by both the share button and the
     * QR code generator. It collects keys beginning with "files-" and the
     * custom-locations key, encodes them to base64 and returns a URL with a
     * hash fragment.
     */
    function buildShareUrl() {
      var shareData = {};
      for (var i = 0; i < localStorage.length; i++) {
        var k = localStorage.key(i);
        if (!k) continue;
        if (k.indexOf('files-') === 0 || k === 'custom-locations') {
          try {
            var val = JSON.parse(localStorage.getItem(k));
            shareData[k] = val;
          } catch (e) {}
        }
      }
      // Convert the collected data to a JSON string
      var jsonStr = JSON.stringify(shareData);
      // Compress the JSON using LZ‑String. compressToEncodedURIComponent returns a URI‑safe
      // representation which does not need additional encoding.
      var compressed = LZString.compressToEncodedURIComponent(jsonStr);
      return window.location.origin + window.location.pathname + '#data=' + compressed;
    }

    // Override the existing generateShareLink to use buildShareUrl and avoid duplication
    function generateShareLink() {
      var url = buildShareUrl();
      window.prompt('Zkopírujte tento odkaz pro sdílení itineráře s vašimi soubory:', url);
    }

    /**
     * Share the current itinerary using the Web Share API when supported. This helper
     * builds a compressed share URL using buildShareUrl() and then calls
     * navigator.share() with a title and description. If the Web Share API
     * is unavailable (e.g. on desktop browsers), the function falls back to
     * displaying a prompt with the shareable URL so the user can copy it.
     */
    function shareItinerary() {
      var url = buildShareUrl();
      // Attempt to use the native Web Share API on supported devices/browsers
      if (navigator.share) {
        navigator.share({
          title: 'Můj Zittau itinerář',
          text: 'Podívej se na trasu a soubory, co jsem si připravil.',
          url: url
        }).catch(function(err) {
          // If sharing fails (for example if the user cancels), just log the error
          console.error('Chyba při sdílení:', err);
        });
      } else {
        // Fallback when Web Share API is unavailable: attempt to copy the URL to the clipboard.
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(function() {
            alert('Odkaz byl zkopírován do schránky.');
          }, function() {
            // If writing to clipboard fails, show a prompt for manual copy
            window.prompt('Zkopírujte tento odkaz pro sdílení itineráře s vašimi soubory:', url);
          });
        } else {
          // If the Clipboard API is not available, fall back to a simple prompt
          window.prompt('Zkopírujte tento odkaz pro sdílení itineráře s vašimi soubory:', url);
        }
      }
    }

    // QR code generation: when the QR button is clicked, generate a QR code
    var qrBtn = document.getElementById('qrBtn');
    var qrContainer = document.getElementById('qrContainer');
    var qrClose = document.getElementById('qrClose');
    if (qrBtn && qrContainer) {
      qrBtn.addEventListener('click', function() {
        var url = buildShareUrl();
        if (typeof QRCode !== 'undefined') {
          var qrDiv = document.getElementById('qrcode');
          qrDiv.innerHTML = '';
          /* eslint-disable no-new */
          new QRCode(qrDiv, {
            text: url,
            width: 256,
            height: 256,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
          });
          qrContainer.style.display = 'block';
          // Update the 'open in Safari' link for iOS users
          var openLink = document.getElementById('openSafariLink');
          if (openLink) {
            openLink.href = url;
            openLink.style.display = 'block';
          }
        } else {
          alert('QR knihovna není načtena.');
        }
      });
    }
    if (qrClose && qrContainer) {
      qrClose.addEventListener('click', function() {
        qrContainer.style.display = 'none';
        // Hide the open Safari link when closing QR container
        var openLink = document.getElementById('openSafariLink');
        if (openLink) {
          openLink.style.display = 'none';
        }
      });
    }

    // Apply dark theme to the page when the user selects the night theme
    if (themeSelectElement) {
      themeSelectElement.addEventListener('change', function() {
        var theme = this.value;
        if (theme === 'night') {
          document.body.classList.add('dark-theme');
        } else {
          document.body.classList.remove('dark-theme');
        }
      });
      // On page load ensure body class matches the selected theme
      window.addEventListener('load', function() {
        if (themeSelectElement.value === 'night') {
          document.body.classList.add('dark-theme');
        }
      });
    }

    // Battery saver mode: monitor device battery and adjust the map and UI when
    // the battery is low. When enabled it switches to a simplified tile layer,
    // reduces geolocation accuracy and disables animations via the reduce-motion
    // class on the body element.
    var batterySaverLayer = null;
    var batterySaverActive = false;
    window._lowPowerGeo = false;
    function enableBatterySaver() {
      if (batterySaverActive) return;
      batterySaverActive = true;
      document.body.classList.add('reduce-motion');
      // Swap out the current base layer for a light, label-free tile set
      if (map.hasLayer(currentBase)) {
        map.removeLayer(currentBase);
      }
      batterySaverLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap přispěvatelé, © Carto'
      });
      currentBase = batterySaverLayer;
      currentBase.addTo(map);
      window._lowPowerGeo = true;
    }
    function disableBatterySaver() {
      if (!batterySaverActive) return;
      batterySaverActive = false;
      document.body.classList.remove('reduce-motion');
      if (map.hasLayer(currentBase)) {
        map.removeLayer(currentBase);
      }
      // Restore the appropriate base layer based on the selected theme
      var theme = themeSelectElement ? themeSelectElement.value : 'day';
      if (theme === 'night') {
        currentBase = nightLayer;
      } else {
        currentBase = dayLayer;
      }
      currentBase.addTo(map);
      window._lowPowerGeo = false;
    }
    if (navigator.getBattery) {
      navigator.getBattery().then(function(battery) {
        function updateBatterySaver() {
          var low = battery.level <= 0.2 && !battery.charging;
          if (low) {
            enableBatterySaver();
          } else {
            disableBatterySaver();
          }
        }
        updateBatterySaver();
        battery.addEventListener('levelchange', updateBatterySaver);
        battery.addEventListener('chargingchange', updateBatterySaver);
      });
    }

    // Override the geolocation handler to honour low power options. Remove the
    // previous click listener if present to avoid duplicate handlers.
    if (locateBtn) {
      var cloneLocateBtn = locateBtn.cloneNode(true);
      locateBtn.parentNode.replaceChild(cloneLocateBtn, locateBtn);
      locateBtn = cloneLocateBtn;
      locateBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
          alert('Geolokace není podporována ve vašem prohlížeči.');
          return;
        }
        var options = {};
        if (window._lowPowerGeo) {
          options.enableHighAccuracy = false;
          options.maximumAge = 60000;
          options.timeout = 10000;
        } else {
          options.enableHighAccuracy = true;
          options.maximumAge = 0;
          options.timeout = 10000;
        }
        navigator.geolocation.getCurrentPosition(function(pos) {
          var lat = pos.coords.latitude;
          var lon = pos.coords.longitude;
          if (window._userMarker) map.removeLayer(window._userMarker);
          if (window._userCircle) map.removeLayer(window._userCircle);
          window._userMarker = L.marker([lat, lon], {
            icon: L.icon({
              iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png'
            })
          }).addTo(map);
          window._userCircle = L.circle([lat, lon], {
            radius: pos.coords.accuracy || 0,
            color: '#136aec',
            fillColor: '#136aec',
            fillOpacity: 0.15
          }).addTo(map);
          map.setView([lat, lon], 13);
        }, function(err) {
          alert('Nelze získat polohu: ' + err.message);
        }, options);
      });
    }

    // Simple chatbot implementation for answering common queries.
    (function() {
      var chatToggle = document.getElementById('chatToggle');
      var chatBox = document.getElementById('chatBox');
      var chatMessages = document.getElementById('chatMessages');
      var chatInput = document.getElementById('chatInput');
      var chatSend = document.getElementById('chatSend');
      function addChatMessage(text, sender) {
        var p = document.createElement('p');
        p.textContent = text;
        p.style.margin = '4px 0';
        p.style.padding = '4px';
        p.style.borderRadius = '4px';
        if (sender === 'user') {
          p.style.backgroundColor = '#e0f0ff';
          p.style.alignSelf = 'flex-end';
        } else {
          p.style.backgroundColor = '#f0f0f0';
        }
        chatMessages.appendChild(p);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function answerQuery(q) {
        /*
         * Vylepšená funkce pro zodpovídání dotazů. Dotaz se normalizuje
         * do malých písmen bez diakritiky a poté se porovnává proti
         * databázi znalostí. Každá položka definuje seznam klíčových
         * slov a odpověď. Pokud se dotaz shoduje s některou položkou,
         * vrátí se její odpověď. Speciální kontrola „kolik“ vrátí
         * počet bodů v itineráři. Pokud se dotaz neshoduje s žádnou
         * známou položkou, vrátí se obecná odpověď s návodem.
         */
        var text = q.toLowerCase();
        var clean = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        function containsAny(query, keys) {
          return keys.some(function(k) { return query.indexOf(k) !== -1; });
        }
        // Znalostní databáze: každá položka obsahuje klíčová slova a odpověď.
        var knowledgeEntries = [
          {
            keys: ['pop art','pop-art','mandauer','kunstlerviertel','kustlerviertel'],
            answer: 'Pop‑Art Viertel (Mandauer Glanz) je největší pop‑art čtvrť v Německu; nachází se v centru Zittau a zdobí ji barevné nástěnné malby a sochy od Sergeje Alexandra Dotta, včetně 16 metrů dlouhého zlatého oblouku ve tvaru DNA【964011512737499†L141-L184】.'
          },
          {
            keys: ['schmalspurbahn','uzkokolejka','narrow gauge','steam train','vlak','train'],
            answer: 'Zittauer Schmalspurbahn je historická úzkokolejná dráha spojující Zittau s horskými letovisky Jonsdorf a Oybin. Děti do 14 let cestují zdarma a psi či malé domácí mazlíčky v přepravních schránách přepravují zdarma【678777931514936†L114-L117】. U držitelů sítových jízdenek se platí malý příplatek za historickou parní trať.'
          },
          {
            keys: ['oybin','hradu','klaster','monastery','castle','klaster','kláster'],
            answer: 'Na pískovcovém vrchu Oybin se nacházejí romantické zříceniny hradu a celestýnského kláštera. Významné opevnění z 14. století nechal vybudovat císař Karel IV.; dnes je součástí poutní trasy Via Sacra a proslavili jej malíři Caspar David Friedrich a Carl Gustav Carus【748801321461841†L94-L104】.'
          },
          {
            keys: ['topfer','toepfer','töpfer','topferberg'],
            answer: 'Töpferberg (Töpfer) je vrch v Žitavských horách s vyhlášenými pískovcovými útvary pojmenovanými „želva“ a „papoušek“. Trasa je středně náročná a vhodná i pro psy na vodítku.'
          },
          {
            keys: ['nonnenfelsen','nonnen','nunfelsen'],
            answer: 'Nonnenfelsen jsou dramatické skalní věže s úzkými průchody a vyhlídkami v okolí Jonsdorfu. Cesty jsou zajištěny schody a žebříky a jsou zvládnutelné s opatrností i pro psy na vodítku.'
          },
          {
            keys: ['jonsdorf','felsenstadt','skalni mesto','skalni','rock city'],
            answer: 'Jonsdorf, nazývaný také Felsenstadt (Skalní město), je labyrint pískovcových útvarů vhodný k procházkám. Najdete zde také horské koupaliště Gebirgsbad Jonsdorf.'
          },
          {
            keys: ['breiteberg','breite','breitenberg'],
            answer: 'Breiteberg je vrch s rozhlednou, odkud se nabízejí výhledy do Německa, Polska i Česka. Výstup vede lesem a je přátelský k psům.'
          },
          {
            keys: ['olbersdorfer','see','jezero','koupani','koupani','koupani','koupání','plaz'],
            answer: 'Olbersdorfer See je rekreační jezero s pláží, piknikovými místy a vyhrazenou psí zónou pro koupání. Voda je vhodná pro psy a vstup je zdarma.'
          },
          {
            keys: ['dreiland','dreilander','trojmezi','tripoint','tri nation','tri-nation','trojmez'],
            answer: 'Dreiländereck u Hrádku nad Nisou je místo, kde se stýkají hranice Německa, Polska a Česka v soutoku Lužické Nisy a Oldřichovského potoka. Místo zdobí symbolický trojboký obelisk, zvonice a vlajky všech tří zemí【22204773861544†L17-L51】.'
          },
          {
            keys: ['tierpark','zoo','zittau zoo','zoological','zoologicka'],
            answer: 'Tierpark Zittau (Zoo im Dreiländereck) je malá zoo ve Weinauparku, která chová asi 380 zvířat z přibližně 70 druhů a byla založena v roce 1965【439528428508119†L61-L66】. Psi na vodítku jsou zde obvykle vítáni.'
          },
          {
            keys: ['waltersdorf'],
            answer: 'Waltersdorf je ves s typickými roubenými domy. Je ideální pro klidné procházky podél Mandavy nebo přes údolí Triebeltal.'
          },
          {
            keys: ['dog','psi','pejsek','mazlicek','mazlicek','mazlícek','mazlíček','pet'],
            answer: 'Většina míst v itineráři je přátelská k psům. Na úzkokolejné železnici se psi přepravují zdarma v přepravních schránách【678777931514936†L114-L117】. Při návštěvách ruin, skal a jezer mějte psa na vodítku a respektujte místní pravidla.'
          },
          {
            keys: ['sdilet','sdileni','share','odkaz','qr','qrcode','link'],
            answer: 'Pro sdílení itineráře použijte tlačítko „Vygenerovat odkaz“ nebo „QR kód“. Aplikace vytvoří komprimovaný odkaz obsahující vaše nahrané soubory a místa; odkaz můžete poslat přátelům nebo načíst pomocí QR čtečky.'
          },
          {
            keys: ['offline','rezim','cache','baterie','battery','mimo site'],
            answer: 'Offline režim zapnete přepínačem „Offline mód“. Stránka pak bude načítat mapové dlaždice pouze z mezipaměti, což šetří data. Díky instalovanému PWA a service workeru fungují mapa a přílohy i bez připojení k síti. Když je baterie nízká, aplikace automaticky omezí animace a použije jednodušší dlaždice.'
          },
          {
            keys: ['tema','temu','dark','nocni','night','svetly','light','tmavy','tmavý'],
            answer: 'V nabídce „Téma mapy“ lze přepínat mezi denním a nočním vzhledem. V nočním režimu se použijí tmavší dlaždice a celé rozhraní se přepne do tmavého režimu. Lze tak šetřit baterii a oči.'
          }
        ];
        // Pokud dotaz obsahuje „kolik“, vrať počet bodů v itineráři
        if (clean.indexOf('kolik') !== -1) {
          var totalPlaces = locations.length;
          return 'V itineráři je celkem ' + totalPlaces + ' bodů. Vyberte konkrétní den v rozbalovacím menu pro podrobnosti.';
        }
        // Vyhledání odpovědi v databázi
        for (var i = 0; i < knowledgeEntries.length; i++) {
          var entry = knowledgeEntries[i];
          if (containsAny(clean, entry.keys)) {
            return entry.answer;
          }
        }
        // Obecná odpověď
        return 'Dotazu nerozumím. Prosím, ptejte se na konkrétní místo nebo funkci této stránky (např. sdílení, offline režim, téma).';
      }
      if (chatToggle) {
        chatToggle.addEventListener('click', function() {
          if (chatBox.style.display === 'none' || chatBox.style.display === '') {
            chatBox.style.display = 'flex';
          } else {
            chatBox.style.display = 'none';
          }
        });
      }
      if (chatSend && chatInput) {
        chatSend.addEventListener('click', function() {
          var val = chatInput.value.trim();
          if (!val) return;
          addChatMessage(val, 'user');
          var resp = answerQuery(val);
          addChatMessage(resp, 'bot');
          chatInput.value = '';
        });
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            chatSend.click();
          }
        });
      }
    })();

    // Assign a random colour for any new day encountered. Initializes structures for new days.
    function getColorForDay(day) {
      if (!dayColors[day]) {
        var hue = Math.floor(Math.random() * 360);
        var pastel = 'hsl(' + hue + ',70%,60%)';
        var dummyCanvas = document.createElement('canvas');
        var ctx = dummyCanvas.getContext('2d');
        ctx.fillStyle = pastel;
        var hex = ctx.fillStyle;
        dayColors[day] = hex;
        dayRoutes[day] = [];
        dayMarkers[day] = [];
        dayPolylines[day] = null;
      }
      return dayColors[day];
    }

    // Persist current locations array to localStorage
    function saveCustomLocations() {
      try {
        // Ulož lokace do localStorage
        localStorage.setItem('custom-locations', JSON.stringify(locations));
        // Odeslání dat ostatním panelům pro synchronizaci
        broadcastLocations();
      } catch (e) {
        console.warn('Ukládání míst se nezdařilo:', e);
      }
    }

    // Admin mode toggling
    var adminMode = false;
    var adminToggleBtn = document.getElementById('adminToggle');
    if (adminToggleBtn) {
      adminToggleBtn.addEventListener('click', function() {
        adminMode = !adminMode;
        // Inform the user about using Shift+click to add new points while in admin mode.
        adminToggleBtn.textContent = adminMode ? 'Admin: ON (Shift+klik)' : 'Admin: OFF';
        if (adminMode) {
          enableAdminMode();
        } else {
          disableAdminMode();
        }
      });
    }
    function enableAdminMode() {
      // Enable dragging on all markers. We no longer need to intercept marker
      // click events because adding new points is triggered only by a
      // shift‑click on the map (handled in onMapClickToAdd). This means
      // clicking an existing marker will open its popup normally while
      // still allowing new markers to be added with shift+click.
      Object.keys(dayMarkers).forEach(function(day) {
        dayMarkers[day].forEach(function(m) {
          if (m.dragging) m.dragging.enable();
        });
      });
      // Attach the map click listener that adds a new point when the user
      // clicks on an empty area of the map. This is only active in admin
      // mode.
      map.on('click', onMapClickToAdd);
    }
    function disableAdminMode() {
      // Disable dragging on all markers and remove the propagation blocker
      Object.keys(dayMarkers).forEach(function(day) {
        dayMarkers[day].forEach(function(m) {
          if (m.dragging) m.dragging.disable();
          if (m._adminStopHandler) {
            m.off('click', m._adminStopHandler);
          }
        });
      });
      // Remove the admin click listener on the map so normal clicks are not
      // intercepted once admin mode is turned off.
      map.off('click', onMapClickToAdd);
    }
    function onMapClickToAdd(ev) {
      // Only allow adding a new point when the user holds the Shift key.
      // This eliminates conflicts between clicking existing markers to view
      // their popups and the admin "add new" workflow. If the shift key is
      // not held down during the click, do nothing.
      var originalEvent = ev.originalEvent;
      if (!originalEvent || !originalEvent.shiftKey) {
        return;
      }
      // Do not create a new location if clicking on a marker or very close
      // to an existing one. Use a distance threshold to avoid duplicate
      // prompts when clicking near a marker. Leaflet's distance() returns
      // meters; a ~50 m threshold covers slight mis-clicks at lower zoom.
      var clickedLatLng = ev.latlng;
      var skip = false;
      Object.keys(dayMarkers).forEach(function(day) {
        dayMarkers[day].forEach(function(m) {
          var pos = m.getLatLng();
          try {
            var dist = map.distance(clickedLatLng, pos);
            if (dist < 50) {
              skip = true;
            }
          } catch (err) {}
        });
      });
      if (skip) return;
      var coord = [clickedLatLng.lat, clickedLatLng.lng];
      var name = prompt('Zadejte název nového místa:');
      if (!name) return;
      var day = prompt('Zadejte den (Středa, Čtvrtek, Pátek, Sobota, Neděle, Pondělí nebo nový den):');
      if (!day) return;
      var details = prompt('Zadejte popis (použijte \n pro nový řádek):');
      if (details === null) return;
      details = details.replace(/\n/g, '<br>');
      var newLoc = { id: 'custom-' + Date.now(), day: day, name: name, coords: coord, details: details };
      locations.push(newLoc);
      if (!dayRoutes[day]) dayRoutes[day] = [];
      dayRoutes[day].push(coord);
      var color = getColorForDay(day);
      var marker = createDayMarker(coord, color);
      marker.addTo(map);
      marker.bindTooltip(name);
      var index = locations.length - 1;
      var inputId = 'file-input-' + index;
      var listId = 'file-list-' + index;
      var editBtnId = 'edit-btn-' + index;
      var deleteBtnId = 'delete-btn-' + index;
      var popupContent = '<b>' + day + ' – ' + name + '</b><br>' + details +
        '<hr style="margin:4px 0;">' +
        '<label>📎 Nahraj soubor (např. jízdenku): <input type="file" id="' + inputId + '"></label>' +
        '<div id="' + listId + '" style="margin-top:4px;"></div>' +
        '<div id="admin-controls-' + index + '" style="display:none; margin-top:4px;">' +
          '<button id="' + editBtnId + '" style="margin-right:4px;">Upravit</button>' +
          '<button id="' + deleteBtnId + '">Smazat</button>' +
        '</div>';
      marker.bindPopup(popupContent);
      marker.on('popupopen', function() {
        var fileInput = document.getElementById(inputId);
        var fileListDiv = document.getElementById(listId);
        function renderFileList(files) {
          fileListDiv.innerHTML = '';
          if (!files || files.length === 0) return;
          files.forEach(function(file) {
            var link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            link.textContent = '🗎 ' + file.name;
            link.style.display = 'block';
            fileListDiv.appendChild(link);
          });
        }
        var stored = localStorage.getItem('files-' + newLoc.id);
        var storedFiles = stored ? JSON.parse(stored) : [];
        renderFileList(storedFiles);
        if (fileInput && !fileInput._listenerAdded) {
          fileInput.addEventListener('change', function(ev) {
            var selected = ev.target.files;
            if (!selected || selected.length === 0) return;
            var file = selected[0];
            // Compress image files before saving to reduce payload size
            if (/^image\//.test(file.type)) {
              compressImage(file, 1024, function(dataUrl) {
                storedFiles.push({ name: file.name, data: dataUrl });
                try {
                  localStorage.setItem('files-' + newLoc.id, JSON.stringify(storedFiles));
                } catch (e) {}
                renderFileList(storedFiles);
              });
            } else {
              var reader = new FileReader();
              reader.onload = function(e) {
                storedFiles.push({ name: file.name, data: e.target.result });
                try {
                  localStorage.setItem('files-' + newLoc.id, JSON.stringify(storedFiles));
                } catch (e) {}
                renderFileList(storedFiles);
              };
              reader.readAsDataURL(file);
            }
          });
          fileInput._listenerAdded = true;
        }
        var adminDiv = document.getElementById('admin-controls-' + index);
        if (adminDiv) {
          adminDiv.style.display = adminMode ? 'block' : 'none';
          var editBtn = document.getElementById(editBtnId);
          var delBtn = document.getElementById(deleteBtnId);
          if (editBtn && !editBtn._listenerAdded) {
            editBtn.addEventListener('click', function(ev) {
              ev.stopPropagation();
              var newName = prompt('Nový název:', newLoc.name);
              if (!newName) return;
              var newDay = prompt('Nový den:', newLoc.day);
              if (!newDay) return;
              var newDetails = prompt('Nový popis:', newLoc.details.replace(/<br>/g, '\n'));
              if (newDetails === null) return;
              newLoc.name = newName;
              newLoc.day = newDay;
              newLoc.details = newDetails.replace(/\n/g, '<br>');
              marker.setTooltipContent(newName);
              getColorForDay(newDay);
              marker.setStyle({ color: dayColors[newDay], fillColor: dayColors[newDay] });
              var updatedPopup = '<b>' + newLoc.day + ' – ' + newLoc.name + '</b><br>' + newLoc.details +
                '<hr style="margin:4px 0;">' +
                '<label>📎 Nahraj soubor (např. jízdenku): <input type="file" id="' + inputId + '"></label>' +
                '<div id="' + listId + '" style="margin-top:4px;"></div>' +
                '<div id="admin-controls-' + index + '" style="' + (adminMode ? '' : 'display:none;') + ' margin-top:4px;">' +
                  '<button id="' + editBtnId + '" style="margin-right:4px;">Upravit</button>' +
                  '<button id="' + deleteBtnId + '">Smazat</button>' +
                '</div>';
              marker.setPopupContent(updatedPopup);
              saveCustomLocations();
            });
            editBtn._listenerAdded = true;
          }
          if (delBtn && !delBtn._listenerAdded) {
            delBtn.addEventListener('click', function(ev) {
              ev.stopPropagation();
              if (!confirm('Opravdu smazat tento bod?')) return;
              map.removeLayer(marker);
              var idxGlobal = locations.indexOf(newLoc);
              if (idxGlobal >= 0) locations.splice(idxGlobal, 1);
              var arrR = dayRoutes[newLoc.day];
              if (arrR) {
                for (var j = 0; j < arrR.length; j++) {
                  if (arrR[j][0] === coord[0] && arrR[j][1] === coord[1]) {
                    arrR.splice(j, 1);
                    break;
                  }
                }
              }
              var arrM = dayMarkers[newLoc.day];
              if (arrM) {
                var p = arrM.indexOf(marker);
                if (p >= 0) arrM.splice(p, 1);
              }
              localStorage.removeItem('files-' + newLoc.id);
              saveCustomLocations();
            });
            delBtn._listenerAdded = true;
          }
        }
      });
      dayMarkers[day].push(marker);
      saveCustomLocations();
      updateVisibility(daySelectElement.value);
    }

    // For existing markers: show admin controls and attach edit/delete handlers on popup open
    locations.forEach(function(loc) {
      var mArray = dayMarkers[loc.day];
      if (mArray) {
        mArray.forEach(function(m) {
          m.on('popupopen', function() {
            var idx = locations.indexOf(loc);
            var adminDiv = document.getElementById('admin-controls-' + idx);
            if (adminDiv) {
              adminDiv.style.display = adminMode ? 'block' : 'none';
              var editId = 'edit-btn-' + idx;
              var delId = 'delete-btn-' + idx;
              var editB = document.getElementById(editId);
              var delB = document.getElementById(delId);
              if (editB && !editB._listenerAdded) {
                editB.addEventListener('click', function(ev) {
                  ev.stopPropagation();
                  var newName = prompt('Nový název:', loc.name);
                  if (!newName) return;
                  var newDay = prompt('Nový den:', loc.day);
                  if (!newDay) return;
                  var newDetails = prompt('Nový popis:', loc.details.replace(/<br>/g, '\n'));
                  if (newDetails === null) return;
                  var oldDay = loc.day;
                  loc.name = newName;
                  loc.day = newDay;
                  loc.details = newDetails.replace(/\n/g, '<br>');
                  m.setTooltipContent(newName);
                  if (oldDay !== newDay) {
                    var oArr = dayMarkers[oldDay];
                    var posInOld = oArr.indexOf(m);
                    if (posInOld >= 0) oArr.splice(posInOld, 1);
                    if (!dayMarkers[newDay]) dayMarkers[newDay] = [];
                    dayMarkers[newDay].push(m);
                    var rOld = dayRoutes[oldDay];
                    for (var i2 = 0; i2 < rOld.length; i2++) {
                      if (rOld[i2][0] === loc.coords[0] && rOld[i2][1] === loc.coords[1]) {
                        rOld.splice(i2, 1);
                        break;
                      }
                    }
                    if (!dayRoutes[newDay]) dayRoutes[newDay] = [];
                    dayRoutes[newDay].push(loc.coords);
                  }
                  getColorForDay(newDay);
                  m.setStyle({ color: dayColors[newDay], fillColor: dayColors[newDay] });
                  var inputId2 = 'file-input-' + idx;
                  var listId2 = 'file-list-' + idx;
                  var updated = '<b>' + loc.day + ' – ' + loc.name + '</b><br>' + loc.details +
                    '<hr style="margin:4px 0;">' +
                    '<label>📎 Nahraj soubor (např. jízdenku): <input type="file" id="' + inputId2 + '"></label>' +
                    '<div id="' + listId2 + '" style="margin-top:4px;"></div>' +
                    '<div id="admin-controls-' + idx + '" style="' + (adminMode ? '' : 'display:none;') + ' margin-top:4px;">' +
                      '<button id="edit-btn-' + idx + '" style="margin-right:4px;">Upravit</button>' +
                      '<button id="delete-btn-' + idx + '">Smazat</button>' +
                    '</div>';
                  m.setPopupContent(updated);
                  saveCustomLocations();
                  updateVisibility(daySelectElement.value);
                });
                editB._listenerAdded = true;
              }
              if (delB && !delB._listenerAdded) {
                delB.addEventListener('click', function(ev) {
                  ev.stopPropagation();
                  if (!confirm('Opravdu smazat tento bod?')) return;
                  map.removeLayer(m);
                  var gIdx = locations.indexOf(loc);
                  if (gIdx >= 0) locations.splice(gIdx, 1);
                  var rArr = dayRoutes[loc.day];
                  for (var k = 0; k < rArr.length; k++) {
                    if (rArr[k][0] === loc.coords[0] && rArr[k][1] === loc.coords[1]) {
                      rArr.splice(k, 1);
                      break;
                    }
                  }
                  var mArr2 = dayMarkers[loc.day];
                  var pos2 = mArr2.indexOf(m);
                  if (pos2 >= 0) mArr2.splice(pos2, 1);
                  localStorage.removeItem('files-' + loc.id);
                  saveCustomLocations();
                  updateVisibility(daySelectElement.value);
                });
                delB._listenerAdded = true;
              }
            }
          });
        });
      }
    });

    // GPS tracking and heatmap drawing
    var trackingToggle = document.getElementById('trackingToggle');
    var trackingOn = false;
    var trackingCoords = [];
    var trackingWatchId = null;
    var trackingCircles = [];
    function drawHeatmap() {
      trackingCircles.forEach(function(c) { map.removeLayer(c); });
      trackingCircles = [];
      trackingCoords.forEach(function(c) {
        var circle = L.circle(c, { radius: 20, color: 'red', fillColor: 'red', fillOpacity: 0.05, weight: 0 });
        circle.addTo(map);
        trackingCircles.push(circle);
      });
    }
    function startTracking() {
      if (!navigator.geolocation) {
        alert('Geolokace není podporována ve vašem prohlížeči.');
        return;
      }
      var options = {};
      if (window._lowPowerGeo) {
        options.enableHighAccuracy = false;
        options.maximumAge = 60000;
        options.timeout = 10000;
      } else {
        options.enableHighAccuracy = true;
        options.maximumAge = 0;
        options.timeout = 10000;
      }
      trackingWatchId = navigator.geolocation.watchPosition(function(pos) {
        var lat = pos.coords.latitude;
        var lon = pos.coords.longitude;
        trackingCoords.push([lat, lon]);
        try {
          localStorage.setItem('tracking-data', JSON.stringify(trackingCoords));
        } catch (e) {}
        drawHeatmap();
      }, function(err) {
        console.warn('Chyba sledování:', err);
      }, options);
    }
    function stopTracking() {
      if (navigator.geolocation && trackingWatchId !== null) {
        navigator.geolocation.clearWatch(trackingWatchId);
        trackingWatchId = null;
      }
    }
    if (trackingToggle) {
      try {
        var savedTrack = localStorage.getItem('tracking-data');
        if (savedTrack) {
          trackingCoords = JSON.parse(savedTrack);
          drawHeatmap();
        }
      } catch (e) {}
      trackingToggle.addEventListener('change', function() {
        trackingOn = this.checked;
        if (trackingOn) {
          startTracking();
        } else {
          stopTracking();
        }
      });
    }

    // ------------------------------------------------
    // Additional PWA enhancements and iOS support logic
    // ------------------------------------------------

    /**
     * Update the online/offline indicator at the top of the page.  When offline,
     * show a red bar with text "Offline"; when online, show a green bar.
     */
    function updateOnlineStatus() {
      var indicator = document.getElementById('offlineIndicator');
      if (!indicator) return;
      if (navigator.onLine) {
        indicator.textContent = 'Online';
        indicator.classList.remove('offline');
        indicator.classList.add('online');
      } else {
        indicator.textContent = 'Offline';
        indicator.classList.remove('online');
        indicator.classList.add('offline');
      }
    }
    // Monitor connectivity changes
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    // Initialize status on script load
    updateOnlineStatus();

    /**
     * Display an Add‑to‑Home‑Screen banner for iOS Safari users who are not
     * already running the app in standalone mode.  Once dismissed, the banner
     * will not reappear (tracked via localStorage).
     */
    function maybeShowInstallBanner() {
      var banner = document.getElementById('installBanner');
      if (!banner) return;
      var isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
      var inStandalone = (window.navigator.standalone === true);
      if (isIos && !inStandalone) {
        var dismissed = localStorage.getItem('installBannerDismissed');
        if (!dismissed) {
          banner.style.display = 'block';
        }
      }
    }
    var installCloseBtn = document.getElementById('installClose');
    if (installCloseBtn) {
      installCloseBtn.addEventListener('click', function() {
        var banner = document.getElementById('installBanner');
        if (banner) banner.style.display = 'none';
        localStorage.setItem('installBannerDismissed', '1');
      });
    }
    maybeShowInstallBanner();

    /**
     * Info modal for version, last save time and error logs.  Provides a
     * simple interface for users to view diagnostic information and export
     * logs for debugging.
     */
    (function() {
      var infoBtn = document.getElementById('infoBtn');
      var infoModal = document.getElementById('infoModal');
      var infoClose = document.getElementById('infoClose');
      var exportLogBtn = document.getElementById('exportLog');
      if (infoBtn && infoModal) {
        infoBtn.addEventListener('click', function() {
          // Populate version and last saved info
          var versionEl = document.getElementById('itineraryVersion');
          var lastSavedEl = document.getElementById('lastSaved');
          var errorLogEl = document.getElementById('errorLog');
          // Hard coded itinerary version; update this value as needed
          var version = '1.0.0';
          if (versionEl) versionEl.textContent = version;
          // Determine when the itinerary was last saved
          var lastSaved = localStorage.getItem('itinerary-last-saved');
          if (lastSaved && lastSaved !== 'undefined') {
            try {
              var dt = new Date(parseInt(lastSaved, 10));
              if (lastSavedEl) lastSavedEl.textContent = dt.toLocaleString();
            } catch (e) {
              if (lastSavedEl) lastSavedEl.textContent = lastSaved;
            }
          } else {
            if (lastSavedEl) lastSavedEl.textContent = '–';
          }
          // Retrieve stored error logs
          var logs = [];
          try {
            var stored = localStorage.getItem('error-log');
            if (stored) logs = JSON.parse(stored);
          } catch (e) {}
          if (errorLogEl) errorLogEl.textContent = logs.join('\n');
          infoModal.style.display = 'block';
        });
      }
      if (infoClose && infoModal) {
        infoClose.addEventListener('click', function() {
          infoModal.style.display = 'none';
        });
      }
      if (exportLogBtn) {
        exportLogBtn.addEventListener('click', function() {
          var logs = [];
          try {
            var stored = localStorage.getItem('error-log');
            if (stored) logs = JSON.parse(stored);
          } catch (e) {}
          var text = logs.join('\n');
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
              alert('Log byl zkopírován do schránky.');
            }, function() {
              alert('Log:\n' + text);
            });
          } else {
            alert('Log:\n' + text);
          }
        });
      }
    })();

    /**
     * Capture uncaught errors and persist them in localStorage so that they can
     * be exported via the info modal.  Only message, filename and line number
     * are stored to avoid leaking stack traces or PII.
     */
    window.addEventListener('error', function(e) {
      var logs = [];
      try {
        var stored = localStorage.getItem('error-log');
        if (stored) logs = JSON.parse(stored);
      } catch (ex) {}
      logs.push((e.message || 'Error') + ' @ ' + (e.filename || '') + ':' + (e.lineno || ''));
      try {
        localStorage.setItem('error-log', JSON.stringify(logs));
      } catch (ex) {}
    });

    /**
     * On first run, store a timestamp indicating when the itinerary was last
     * saved.  Admin edits or other file changes could update this key in
     * future enhancements.
     */
    (function() {
      if (!localStorage.getItem('itinerary-last-saved')) {
        try {
          localStorage.setItem('itinerary-last-saved', Date.now().toString());
        } catch (e) {}
      }
    })();

    /**
     * Deep link handling: interpret query parameters ?day= and ?place= to
     * automatically highlight the requested day or place when the app loads.
     */
    (function() {
      try {
        var params = new URLSearchParams(window.location.search);
        var dayParam = params.get('day');
        var placeParam = params.get('place');
        if (dayParam) {
          var ds = document.getElementById('daySelect');
          if (ds) {
            ds.value = dayParam;
            updateVisibility(dayParam);
          }
        }
        if (placeParam) {
          var targetName = placeParam.toLowerCase();
          var match = locations.find(function(loc) {
            return loc.name.toLowerCase() === targetName;
          });
          if (match) {
            map.setView(match.coords, 13);
            var marker = dayMarkers[match.day].find(function(m) {
              var ll = m.getLatLng();
              return ll.lat === match.coords[0] && ll.lng === match.coords[1];
            });
            if (marker) {
              marker.openPopup();
            }
          }
        }
      } catch (e) {}
    })();

    /**
     * Compress image files before storing them in localStorage.  Reduces image
     * dimensions to a maximum width while maintaining aspect ratio and
     * compresses the result with a reasonable quality factor.
     *
     * @param {File} file The image file selected by the user
     * @param {number} maxWidth The maximum width (in pixels) allowed for the output image
     * @param {Function} callback Callback invoked with the base64 data URL of the compressed image
     */
    function compressImage(file, maxWidth, callback) {
      if (!/^image\//.test(file.type)) {
        // Not an image; read normally
        var reader = new FileReader();
        reader.onload = function(e) {
          callback(e.target.result);
        };
        reader.readAsDataURL(file);
        return;
      }
      var img = new Image();
      img.onload = function() {
        var scale = 1;
        if (img.width > maxWidth) {
          scale = maxWidth / img.width;
        }
        var canvas = document.createElement('canvas');
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(function(blob) {
          var reader2 = new FileReader();
          reader2.onload = function(ev) {
            callback(ev.target.result);
          };
          reader2.readAsDataURL(blob);
        }, file.type, 0.8);
      };
      img.src = URL.createObjectURL(file);
    }
  </script>
  <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

// Tvoje Firebase konfigurace
const firebaseConfig = {
  apiKey: "AlzaSyBG1zf0sR8mc2-Ea_BkA9HQds3KQPK2us8",
  authDomain: "zittau-itinar.firebaseapp.com",
  projectId: "zittau-itinar",
  storageBucket: "zittau-itinar.appspot.com",
  messagingSenderId: "104396933210",
  appId: "1:104396933210:web:7ace9c08cdd425a7d13063"
};

// Inicializace Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const locRef = ref(db, 'shared_itinerary/locations');

// Pomocná funkce pro překreslení markerů (pokud není ve tvém kódu)
function rebuildMarkersFromLocations() {
  if (typeof dayMarkers === 'object' && typeof map !== 'undefined') {
    // odstranění starých
    Object.values(dayMarkers).flat().forEach(m => m && map.removeLayer(m));
    Object.keys(dayMarkers).forEach(k => dayMarkers[k] = []);
    Object.keys(dayPolylines).forEach(k => {
      if (dayPolylines[k]) {
        map.removeLayer(dayPolylines[k]);
        dayPolylines[k] = null;
      }
    });
    Object.keys(dayRoutes).forEach(k => { dayRoutes[k] = []; });
    // znovu vytvořit podle locations
    locations.forEach((loc, index) => {
      dayRoutes[loc.day] = dayRoutes[loc.day] || [];
      dayRoutes[loc.day].push(loc.coords);
      const marker = createDayMarker(loc.coords, dayColors[loc.day]);
      marker.addTo(map);
      marker.bindTooltip(loc.name);
      // jednoduchý popup (nepřepisuje admin/úpravy)
      marker.bindPopup('<b>' + loc.day + ' – ' + loc.name + '</b><br>' + loc.details);
      if (!dayMarkers[loc.day]) dayMarkers[loc.day] = [];
      dayMarkers[loc.day].push(marker);
    });
    if (typeof updateVisibility === 'function' && typeof daySelectElement !== 'undefined') {
      updateVisibility(daySelectElement.value);
    }
  } else {
    // fallback: reload
    location.reload();
  }
}

// Počkáme až je původní logika dostupná
function whenReady(cb) {
  if (typeof saveCustomLocations === 'function' && typeof locations !== 'undefined') {
    cb();
  } else {
    setTimeout(() => whenReady(cb), 100);
  }
}

whenReady(() => {
  // Sync z Firebase do lokálního stavu
  onValue(locRef, (snapshot) => {
    const remote = snapshot.val();
    if (!remote) return;
    try {
      if (JSON.stringify(remote) !== JSON.stringify(locations)) {
        locations = remote;
        localStorage.setItem('custom-locations', JSON.stringify(locations));
        rebuildMarkersFromLocations();
      }
    } catch (e) {
      console.warn('Firebase sync error:', e);
    }
  });

  // Přepsat saveCustomLocations, aby zapisovalo i do Firebase
  const originalSave = saveCustomLocations;
  saveCustomLocations = function() {
    try {
      localStorage.setItem('custom-locations', JSON.stringify(locations));
    } catch {}
    // push do cloudu
    set(locRef, locations).catch(err => console.warn('Firebase write failed:', err));
    if (typeof broadcastLocations === 'function') broadcastLocations();
    if (originalSave) originalSave();
  };
});
</script>
  <!-- Backup import/export functions placed outside of module scope so they are globally accessible -->
  <script>
  function exportState() {
    try {
      const blob = new Blob([JSON.stringify(locations, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'itinerary.json';
      a.click();
    } catch (err) {
      console.error('Export failed:', err);
      alert('Chyba při exportu dat: ' + err);
    }
  }

  function importState(file) {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imported = JSON.parse(e.target.result);
        locations = imported;
        localStorage.setItem('custom-locations', JSON.stringify(locations));
        if (typeof updateVisibility === 'function' && typeof daySelectElement !== 'undefined') updateVisibility(daySelectElement.value);
        // Uložit do Firebase (pokud je sync k dispozici)
        try {
          if (typeof set === 'function' && typeof locRef !== 'undefined') {
            set(locRef, locations).catch(err => console.warn('Firebase write failed after import:', err));
          }
        } catch {}
      } catch (err) {
        alert('Neplatný JSON: ' + err);
      }
    };
    reader.readAsText(file);
  }
  </script>
</body>
</html>